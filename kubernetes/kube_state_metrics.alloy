declare "kube_state_metrics" {
  argument "targets" {}
  argument "destinations" {}
  argument "scrape_interval" {
    default = "60s"
    optional = true
  }
  argument "clustering_enabled" {
    default = false
    optional = true
  }

  prometheus.scrape "kube_state_metrics" {
    targets = argument.targets.value
    job_name = "integrations/kubernetes/kube-state-metrics"
    scrape_interval = argument.scrape_interval.value
    scheme = "http"
    bearer_token_file = ""
    tls_config {
      insecure_skip_verify = true
    }
  
    clustering {
      enabled = argument.clustering_enabled.value
    }
    forward_to = [prometheus.relabel.kube_state_metrics.receiver]
  }
  
  prometheus.relabel "kube_state_metrics" {
    max_cache_size = 100000
    rule {
      source_labels = ["__name__"]
      regex = "up|scrape_samples_scraped|kube_configmap_info|kube_configmap_metadata_resource_version|kube_daemonset.*|kube_deployment_metadata_generation|kube_deployment_spec_replicas|kube_deployment_status_condition|kube_deployment_status_observed_generation|kube_deployment_status_replicas_available|kube_deployment_status_replicas_updated|kube_horizontalpodautoscaler_spec_max_replicas|kube_horizontalpodautoscaler_spec_min_replicas|kube_horizontalpodautoscaler_status_current_replicas|kube_horizontalpodautoscaler_status_desired_replicas|kube_job.*|kube_namespace_status_phase|kube_node.*|kube_persistentvolume_status_phase|kube_persistentvolumeclaim_access_mode|kube_persistentvolumeclaim_info|kube_persistentvolumeclaim_labels|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_persistentvolumeclaim_status_phase|kube_pod_container_info|kube_pod_container_resource_limits|kube_pod_container_resource_requests|kube_pod_container_status_last_terminated_reason|kube_pod_container_status_last_terminated_timestamp|kube_pod_container_status_restarts_total|kube_pod_container_status_waiting_reason|kube_pod_info|kube_pod_owner|kube_pod_spec_volumes_persistentvolumeclaims_info|kube_pod_start_time|kube_pod_status_phase|kube_pod_status_reason|kube_replicaset.*|kube_resourcequota|kube_secret_metadata_resource_version|kube_statefulset.*"
      action = "keep"
    }
    forward_to = argument.destinations.value
  }
}
